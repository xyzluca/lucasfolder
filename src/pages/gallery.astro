---
import '@/styles/global.css'
import '@/styles/blocks.css'
import BaseLayout from '@/layouts/BaseLayout.astro'
import BlockGrid from '@/components/ui/BlockGrid.astro'
import Footer from '@/components/layout/Footer.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import { getCollection } from 'astro:content'
import { themeConfig } from '@/config'

// Fetch all blocks
const allBlocks = await getCollection('blocks')

// Separate by source
const personalBlocks = allBlocks
  .filter((b) => b.data.source === 'personal')
  .sort((a, b) => new Date(b.data.createdAt).getTime() - new Date(a.data.createdAt).getTime())

const collectedBlocks = allBlocks
  .filter((b) => b.data.source === 'collected')
  .sort((a, b) => new Date(b.data.createdAt).getTime() - new Date(a.data.createdAt).getTime())

const allBlocksSorted = [...personalBlocks, ...collectedBlocks]

const title = 'Gallery'
const description = 'A collection of my work and curated content'
const ogImage = '/open-graph/gallery.png'
---

<BaseLayout
  type="page"
  title={`${title} · ${themeConfig.site.title}`}
  description={description}
  fullWidth={true}
  hideHeader={true}
>
  <BaseHead
    title={`${title} · ${themeConfig.site.title}`}
    description={description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="gallery-fullscreen">
    <!-- Custom Navigation Bar -->
    <nav class="gallery-nav">
      <a href="/" class="gallery-nav-home">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span>Home</span>
      </a>
      <!-- Content Type Tabs in Nav -->
      <div class="content-tabs">
        <button class="tab-btn active" data-content="photos">My Content</button>
        <button class="tab-btn" data-content="collected">Collected</button>
        <button class="tab-btn" data-content="all">All</button>
      </div>
    </nav>

    <!-- My Content Section -->
    <div id="personal-section">
      <BlockGrid blocks={personalBlocks} />
    </div>

    <!-- Collected Section -->
    <div id="collected-section" hidden>
      <BlockGrid blocks={collectedBlocks} />
    </div>

    <!-- All Section -->
    <div id="all-section" hidden>
      <BlockGrid blocks={allBlocksSorted} />
    </div>

    <!-- Footer -->
    <div class="gallery-footer-wrapper">
      <Footer />
    </div>
  </div>
</BaseLayout>

<!-- Load Fancybox for blocks image lightbox -->
<script is:inline>
  ;(async () => {
    const Fancybox = await (await import('/src/utils/fancybox-loader.ts')).loadFancybox()
    if (!document.querySelector('link[data-fancybox-css]')) {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = 'https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.css'
      link.setAttribute('data-fancybox-css', 'true')
      document.head.appendChild(link)
    }
    Fancybox.bind('[data-fancybox="blocks"]', {
      theme: 'auto',
      Carousel: { transition: 'slide' }
    })
  })()
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.tab-btn')
    const personalSection = document.getElementById('personal-section')
    const collectedSection = document.getElementById('collected-section')
    const allSection = document.getElementById('all-section')

    function setActive(buttons: NodeListOf<Element>, target: Element) {
      buttons.forEach((btn) => {
        btn.classList.toggle('active', btn === target)
      })
    }

    // Tab switching
    tabButtons.forEach((btn) =>
      btn.addEventListener('click', () => {
        setActive(tabButtons, btn)
        const currentContent = (btn as HTMLElement).dataset.content || 'photos'

        if (currentContent === 'photos') {
          personalSection?.removeAttribute('hidden')
          collectedSection?.setAttribute('hidden', '')
          allSection?.setAttribute('hidden', '')
        } else if (currentContent === 'collected') {
          personalSection?.setAttribute('hidden', '')
          collectedSection?.removeAttribute('hidden')
          allSection?.setAttribute('hidden', '')
        } else if (currentContent === 'all') {
          personalSection?.setAttribute('hidden', '')
          collectedSection?.setAttribute('hidden', '')
          allSection?.removeAttribute('hidden')
        }
      })
    )
  })
</script>

<style>
  .gallery-fullscreen {
    width: 100%;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    background-color: #fff;
  }

  /* Custom Navigation Bar */
  .gallery-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
    padding: 1.5rem clamp(1.5rem, 4vw, 3rem);
    border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
    background: white;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
    background-color: rgba(255, 255, 255, 0.95);
  }

  .gallery-nav-home {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: #111;
    font-weight: var(--font-weight-semibold, 600);
    transition: opacity 0.2s ease;
    font-size: var(--font-size-m, 1rem);
  }

  .gallery-nav-home:hover {
    opacity: 0.7;
  }

  .gallery-nav-home svg {
    flex-shrink: 0;
  }

  .gallery-nav-title {
    font-size: var(--font-size-m, 1rem);
    font-weight: var(--font-weight-semibold, 600);
    color: #666;
  }

  /* Content Type Tabs in Nav */
  .content-tabs {
    display: flex;
    gap: 0.5rem;
    margin-left: auto;
  }

  .tab-btn {
    background: none;
    border: none;
    padding: 0.5rem 1rem;
    font-size: var(--font-size-s);
    font-family: var(--sans);
    font-weight: var(--font-weight-regular);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 6px;
  }

  .tab-btn:hover {
    color: var(--text-primary);
    background: rgba(0, 0, 0, 0.03);
  }

  .tab-btn.active {
    color: var(--text-primary);
    font-weight: var(--font-weight-semibold);
    background: rgba(0, 0, 0, 0.05);
  }

  .tab-btn:focus-visible {
    outline: 2px solid var(--text-tertiary);
    outline-offset: 2px;
  }

  .gallery-footer-wrapper {
    padding: 3rem clamp(1.5rem, 4vw, 4rem);
  }

  #personal-section[hidden],
  #collected-section[hidden],
  #all-section[hidden] {
    display: none;
  }

  .gallery-pane[hidden] {
    display: none;
  }

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .gallery-nav {
      padding: 1rem;
      flex-wrap: wrap;
    }

    .gallery-nav-home span {
      display: none;
    }

    .content-tabs {
      width: 100%;
      margin-left: 0;
      margin-top: 0.5rem;
      justify-content: center;
    }

    .tab-btn {
      font-size: 0.875rem;
      padding: 0.375rem 0.75rem;
    }
  }
</style>
